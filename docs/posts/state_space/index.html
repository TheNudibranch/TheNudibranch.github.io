<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-05-01">
<meta name="description" content="State Space model estimation using Stan as the inference engine">

<title>An Uhinged Introduction to State Space Models – Ian Costley</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>

<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Ian Costley</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/TheNudibranch"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/ian-s-costley/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#casting-calls" id="toc-casting-calls" class="nav-link active" data-scroll-target="#casting-calls">Casting Calls</a>
  <ul class="collapse">
  <li><a href="#motivation-more-ice-please" id="toc-motivation-more-ice-please" class="nav-link" data-scroll-target="#motivation-more-ice-please">Motivation: More Ice Please</a></li>
  <li><a href="#the-final-frontier" id="toc-the-final-frontier" class="nav-link" data-scroll-target="#the-final-frontier">The final frontier</a></li>
  <li><a href="#i-prefer-autumn" id="toc-i-prefer-autumn" class="nav-link" data-scroll-target="#i-prefer-autumn">I prefer Autumn</a></li>
  <li><a href="#who-got-a-call-back" id="toc-who-got-a-call-back" class="nav-link" data-scroll-target="#who-got-a-call-back">Who got a call back?</a></li>
  </ul></li>
  <li><a href="#setting-the-stage" id="toc-setting-the-stage" class="nav-link" data-scroll-target="#setting-the-stage">Setting the Stage</a>
  <ul class="collapse">
  <li><a href="#mine-is-a-brita" id="toc-mine-is-a-brita" class="nav-link" data-scroll-target="#mine-is-a-brita">Mine is a Brita</a></li>
  <li><a href="#dont-forget-to-moisturize" id="toc-dont-forget-to-moisturize" class="nav-link" data-scroll-target="#dont-forget-to-moisturize">Don’t forget to Moisturize</a></li>
  <li><a href="#lots-and-lots-of-understudies" id="toc-lots-and-lots-of-understudies" class="nav-link" data-scroll-target="#lots-and-lots-of-understudies">Lots and Lots of Understudies</a></li>
  </ul></li>
  <li><a href="#end-of-act-1" id="toc-end-of-act-1" class="nav-link" data-scroll-target="#end-of-act-1">End of Act 1</a>
  <ul class="collapse">
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">An Uhinged Introduction to State Space Models</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Bayes</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Stan</div>
  </div>
  </div>

<div>
  <div class="description">
    State Space model estimation using Stan as the inference engine
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 1, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>state_space_utils <span class="ot">&lt;-</span> <span class="fu">new.env</span>()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'state_space_model_utilities.R'</span>, state_space_utils)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>season_length <span class="ot">&lt;-</span> <span class="dv">7</span>; number_seasons <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>n_tot <span class="ot">&lt;-</span> season_length <span class="sc">*</span> number_seasons</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> (<span class="fu">cumsum</span>(<span class="fu">rnorm</span>(n_tot, <span class="dv">0</span>,<span class="fl">0.5</span>)) <span class="sc">+</span> <span class="fu">rnorm</span>(n_tot, <span class="dv">0</span>,.<span class="dv">01</span>)) <span class="sc">|&gt;</span> <span class="fu">abs</span>()</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> (<span class="fu">cumsum</span>(<span class="fu">rnorm</span>(n_tot, <span class="dv">0</span>,<span class="fl">0.5</span>)) <span class="sc">+</span> <span class="fu">rnorm</span>(n_tot, <span class="dv">0</span>,.<span class="dv">01</span>)) <span class="sc">|&gt;</span> <span class="fu">abs</span>()</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>x_mat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(x1,x2)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>beta_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">2</span><span class="sc">*</span>pi, <span class="at">length.out=</span>season_length))<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> ss <span class="sc">-</span> <span class="fu">mean</span>(ss)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>ss_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(ss)[<span class="sc">-</span><span class="fu">length</span>(ss)]</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>ss_var <span class="ot">&lt;-</span> <span class="fl">0.01</span><span class="sc">^</span><span class="dv">2</span>;</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>slope_start <span class="ot">&lt;-</span> <span class="dv">0</span>; slope_var <span class="ot">&lt;-</span> <span class="fl">1e-30</span>; slope_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(slope_start)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>mu_start <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>); mu_var <span class="ot">&lt;-</span> <span class="fl">0.05</span><span class="sc">^</span><span class="dv">2</span>; mu_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(mu_start)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>noise_var <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>y_vec <span class="ot">&lt;-</span> ss_comp <span class="ot">&lt;-</span>  <span class="fu">c</span>()</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># i &lt;- 1</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_tot){</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  ss_comp <span class="ot">&lt;-</span> <span class="fu">c</span>(ss_vec[<span class="dv">1</span>], ss_comp)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  y_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(y_vec, mu_vec[i] <span class="sc">+</span> (x_mat <span class="sc">%*%</span> beta_vec)[i] <span class="sc">+</span> ss_vec[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fu">sqrt</span>(noise_var)))</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  ss_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fu">sum</span>(ss_vec) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(ss_var)), ss_vec[<span class="sc">-</span><span class="fu">length</span>(ss_vec)])</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  slope_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(slope_vec, slope_vec[i] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(slope_var)))</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  mu_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(mu_vec, mu_vec[i] <span class="sc">+</span> slope_vec[i] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>,<span class="fu">sqrt</span>(mu_var)))</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Add 20% of series mean to the last 10 iterations</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>is_new_prod_live <span class="ot">&lt;-</span> <span class="fu">seq_along</span>(y_vec) <span class="sc">&gt;=</span> <span class="fu">length</span>(y_vec) <span class="sc">-</span> <span class="dv">9</span> </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>y_vec[is_new_prod_live] <span class="ot">&lt;-</span> <span class="fu">abs</span>(y_vec[is_new_prod_live])<span class="sc">*</span><span class="fl">0.5</span> <span class="sc">+</span> </span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  y_vec[is_new_prod_live]</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">leni=</span>y_vec, <span class="at">abdominable=</span>x1, <span class="at">bigfoot=</span>x2) <span class="sc">|&gt;</span> </span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(<span class="st">'state_space_data.csv'</span>, <span class="at">row.names =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="casting-calls" class="level1">
<h1>Casting Calls</h1>
<section id="motivation-more-ice-please" class="level2">
<h2 class="anchored" data-anchor-id="motivation-more-ice-please">Motivation: More Ice Please</h2>
<p>Let’s say you work for a drinkware company, we’ll call it something generic, maybe “<strong>L</strong>arge bi-p<strong>E</strong>dal s<strong>N</strong>ow crypt<strong>I</strong>d”? Or LENI for short. LENI sells mugs, wine glasses, water glasses, and tumblers. The recent lack of innovation in the tumbler market has led to public outcry. As a response, you release Tumbler v2™. This exciting new technology features the same size tumblers you know an love, but with double the ice capacity. You even come up with a catchy slogan:</p>
<center>
<em>“Double the ice, for the exact same price.” - LENI</em>
</center>
<p>As a result of your genius ideas, your tumbler sales being to pick up:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y_vec, <span class="at">type=</span><span class="st">'n'</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">cex.axis=</span><span class="fl">1.2</span>, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">cex.main=</span><span class="fl">1.5</span>, <span class="at">main=</span><span class="st">'Drinkware Company Sales'</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">''</span>, <span class="at">xlab=</span><span class="st">''</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">yaxt=</span><span class="st">'n'</span>, <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(y_vec, x1, x2, ss_comp)))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">1</span>, <span class="at">at=</span><span class="fu">mean</span>(<span class="fu">seq_along</span>(y_vec)), <span class="at">labels=</span><span class="st">'Time'</span>, <span class="at">cex.axis=</span><span class="fl">1.3</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">2</span>, <span class="at">at=</span><span class="fu">mean</span>(y_vec), <span class="at">labels=</span><span class="st">'Sales ($)'</span>, <span class="at">cex.axis=</span><span class="fl">1.3</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x1, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">col=</span><span class="fu">adjustcolor</span>(<span class="st">'darkgoldenrod1'</span>, <span class="fl">0.5</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x2, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">col=</span><span class="fu">adjustcolor</span>(<span class="st">'violet'</span>, <span class="fl">0.5</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y_vec, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">type=</span><span class="st">'b'</span>, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># lines(ss_comp, lwd=3, pch=16, col='gold')</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">length</span>(y_vec)<span class="sc">-</span><span class="fl">9.5</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'LENI'</span>, <span class="st">'Abominable Snowman'</span>, <span class="st">'Bigfoot'</span>, <span class="st">'Release of Tumbler v2™'</span>), </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">lwd=</span><span class="fu">rep</span>(<span class="dv">3</span>,<span class="dv">4</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'darkgoldenrod'</span>, <span class="st">'violet'</span>, <span class="st">'black'</span>), <span class="at">bg=</span><span class="fu">adjustcolor</span>(<span class="st">'white'</span>, <span class="fl">0.5</span>), <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">16</span>,<span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-final-frontier" class="level2">
<h2 class="anchored" data-anchor-id="the-final-frontier">The final frontier</h2>
<p>Your tumbler sales are putting all your rival drinkware companies, like “Abominable Snowman”, to shame. But just how much of your sales are incremental and aren’t just due to the usual seasonality, or positive overall industry growth. Can you quantify with some degree of certain the incremental sales you’ve realized from launching Tumbler v2™?</p>
<p>To approach this problem, we will use state space models. A class of models that assumes that our data generating process has some underlying state that gives rise to our actually observed variables. For instance, in the time series plot above, a state space approach would assume that each point in the time series is generated from some latent unobserved state which has its own distribution. For this time series analysis state space problem, we will used the widely adopted and used approach of <span class="citation" data-cites="book">(<a href="#ref-book" role="doc-biblioref">James Durbin and Koopman 2012</a>)</span>. The governing equation for this system is given by:</p>
<p><span class="math display">\[\begin{equation}
y_t = Z_t\alpha_t + \varepsilon_t \hspace{10mm} \text{(1)}
\end{equation}\]</span> <span class="math display">\[\begin{equation}
\alpha_{t+1} = T_t \alpha_t + R_t \eta_t \hspace{6mm} \text{(2)}
\end{equation}\]</span></p>
<p>where</p>
<p><span class="math display">\[\varepsilon_t \sim \mathcal{N}(0,H_t) \hspace{2mm} \text{and} \hspace{2mm} \eta_t \sim \mathcal{N}(0,Q_t)\]</span> You might only recognize <span class="math inline">\(y_t\)</span>, the sales from our Tumbler v2, from the equation above. But allow me to introduce the full cast of characters:</p>
<div class="cell" data-filters="parse-latex">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>vec_var <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'$y_t$'</span>, <span class="st">'$</span><span class="sc">\\</span><span class="st">alpha_t$'</span>, <span class="st">'$</span><span class="sc">\\</span><span class="st">varepsilon_t$'</span>, <span class="st">'$</span><span class="sc">\\</span><span class="st">eta_t$'</span>, <span class="st">''</span>, <span class="st">'$a_1$'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>vec_dim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'$p </span><span class="sc">\\</span><span class="st">times 1$'</span>, <span class="st">'$m </span><span class="sc">\\</span><span class="st">times 1$'</span>, <span class="st">'$p </span><span class="sc">\\</span><span class="st">times 1$'</span>, <span class="st">'$r </span><span class="sc">\\</span><span class="st">times 1$'</span>, <span class="st">''</span>, <span class="st">'$m </span><span class="sc">\\</span><span class="st">times 1$'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>vec_desc <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Observations'</span>, <span class="st">'State'</span>, <span class="st">'Obs. Disturbance'</span>, <span class="st">'State Disturbance'</span>, <span class="st">''</span>, <span class="st">'Initial State Expected Value'</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>mat_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'$Z_t$'</span>, <span class="st">'$T_t$'</span>, <span class="st">'$H_t$'</span>, <span class="st">'$R_t$'</span>, <span class="st">'$Q_t$'</span>, <span class="st">'$P_1$'</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>mat_dim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'$p </span><span class="sc">\\</span><span class="st">times m$'</span>, <span class="st">'$m </span><span class="sc">\\</span><span class="st">times m$'</span>, <span class="st">'$p </span><span class="sc">\\</span><span class="st">times p$'</span>, <span class="st">'$m </span><span class="sc">\\</span><span class="st">times r$'</span>, <span class="st">'$r </span><span class="sc">\\</span><span class="st">times r$'</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">'$m </span><span class="sc">\\</span><span class="st">times m$'</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>mat_desc <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Design Matrix'</span>, <span class="st">'Transition Matrix'</span>, <span class="st">'Obs. Covariance Matrix'</span>, <span class="st">'State Disturbance Selection Matrix'</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">'State Covariance Matrix'</span>, <span class="st">'Initial State Covariance Matrix'</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(vec_var, vec_dim, vec_desc, mat_vec, mat_dim, mat_desc) <span class="sc">%&gt;%</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names=</span><span class="cn">NULL</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">position=</span><span class="st">'center'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">'Vectors'</span><span class="ot">=</span><span class="dv">3</span>, <span class="st">'Matricies'</span> <span class="ot">=</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Vectors
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Matricies
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<span class="math inline">\(y_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(p \times 1\)</span>
</td>
<td style="text-align:left;">
Observations
</td>
<td style="text-align:left;">
<span class="math inline">\(Z_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(p \times m\)</span>
</td>
<td style="text-align:left;">
Design Matrix
</td>
</tr>
<tr>
<td style="text-align:left;">
<span class="math inline">\(\alpha_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(m \times 1\)</span>
</td>
<td style="text-align:left;">
State
</td>
<td style="text-align:left;">
<span class="math inline">\(T_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(m \times m\)</span>
</td>
<td style="text-align:left;">
Transition Matrix
</td>
</tr>
<tr>
<td style="text-align:left;">
<span class="math inline">\(\varepsilon_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(p \times 1\)</span>
</td>
<td style="text-align:left;">
Obs. Disturbance
</td>
<td style="text-align:left;">
<span class="math inline">\(H_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(p \times p\)</span>
</td>
<td style="text-align:left;">
Obs. Covariance Matrix
</td>
</tr>
<tr>
<td style="text-align:left;">
<span class="math inline">\(\eta_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(r \times 1\)</span>
</td>
<td style="text-align:left;">
State Disturbance
</td>
<td style="text-align:left;">
<span class="math inline">\(R_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(m \times r\)</span>
</td>
<td style="text-align:left;">
State Disturbance Selection Matrix
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
<span class="math inline">\(Q_t\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(r \times r\)</span>
</td>
<td style="text-align:left;">
State Covariance Matrix
</td>
</tr>
<tr>
<td style="text-align:left;">
<span class="math inline">\(a_1\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(m \times 1\)</span>
</td>
<td style="text-align:left;">
Initial State Expected Value
</td>
<td style="text-align:left;">
<span class="math inline">\(P_1\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(m \times m\)</span>
</td>
<td style="text-align:left;">
Initial State Covariance Matrix
</td>
</tr>
</tbody>
</table>
<p>.</p>
</div>
</div>
<p>Here <span class="math inline">\(\alpha_t\)</span> is the underlying latent state that gives rise to our time series realizations <span class="math inline">\(y_t\)</span>. As stated before, the latent state <span class="math inline">\(\alpha_t\)</span> has its own distribution, which we can now deduce from the equation above is given by <span class="math inline">\(\alpha_t \sim \mathcal{N}(a_t, Q_t)\)</span>. Notice from our table above that <span class="math inline">\(\alpha_t\)</span> is not the same size as <span class="math inline">\(y_t\)</span>. Our observations <span class="math inline">\(y_t\)</span> is a vector of length <span class="math inline">\(p\)</span>, which will be 1 for our case here. Conversely, <span class="math inline">\(\alpha_t\)</span> is of size <span class="math inline">\(m\)</span>. This is because <span class="math inline">\(\alpha_t\)</span> will act as the conduit for all the effects and assumptions we impose on the model.</p>
<p>This is one of the best utilities provided by state space models. We have the ability to add smaller effects together and extract them at the end of the modeling process to further understand the structure of our time series. For example, you might want to impose a 52 week seasonality (1 year), positive industry trend growth, additive regression effects, and maybe even a AR(n) process to account for autocorrelation. All of this information is packed in <span class="math inline">\(\alpha_t\)</span> which we’ll demonstrate later.</p>
<p>The matrix <span class="math inline">\(Z_t\)</span> provides the translation from <span class="math inline">\(\mathbb{R}^m\)</span> to <span class="math inline">\(\mathbb{R}^p\)</span>, which our case is just one dimension. Therefore, <span class="math inline">\(Z_t\)</span> reduces down to a vector of length <span class="math inline">\(m\)</span>, but this is not the case in general. Some of the data that <span class="math inline">\(Z_t\)</span> might hold is the <span class="math inline">\(x_t\)</span> for the regression component of our time series. Usually, <span class="math inline">\(Z_t\)</span> is filled with 1s and 0s to select different components of <span class="math inline">\(\alpha_t\)</span> that are used for <span class="math inline">\(y_t\)</span>. As we’ll see later, there are many components of <span class="math inline">\(\alpha_t\)</span> that don’t directly impact <span class="math inline">\(y_t\)</span>, but are strategically placed to help <span class="math inline">\(\alpha_t\)</span> itself evolve over time.</p>
<p>This is a great segue to our transition matrix <span class="math inline">\(T_t\)</span>. The transition matrix is what evolves <span class="math inline">\(\alpha_t\)</span> to the next state <span class="math inline">\(\alpha_{t+1}\)</span>. This again can take multiple forms. It might be the stage in the process where a positive industry trend is added to the overall series or where we move from season to season.</p>
<p>Finally we have <span class="math inline">\(R_t\)</span>, the state disturbance selection matrix. Notice that everything up to this point has had a <span class="math inline">\(t\)</span> subscript. While we are modeling a time series, it is not true that every element of <span class="math inline">\(\alpha_t\)</span> has to vary over time. In fact, most of the time the regression coefficients (if included) are usually static with respect to time. The way we tell this model to account for static elements of <span class="math inline">\(\alpha_t\)</span> is to not add any disturbance to them. Lets consider a very simple local linear trend model:</p>
<p><span class="math display">\[\begin{align}
y_t &amp;= \mu_t + \varepsilon_t\\
\mu_{t + 1} &amp;= \mu_{t} + \nu_{t} + \eta_{t}\\
\nu_{t+1} &amp;= \nu_{t}
\end{align}\]</span></p>
<p>Our cast of characters now wear the following costumes:</p>
<p><span class="math display">\[\alpha_t = \begin{bmatrix} \mu_t \\ \nu_t\end{bmatrix} \hspace{10mm} Z_t = \begin{bmatrix} 1 &amp; 0\\ \end{bmatrix}\]</span> <span class="math display">\[T_t = \begin{bmatrix}1 &amp; 1\\ 0 &amp; 1 \end{bmatrix} \hspace{5mm} R_t = \begin{bmatrix}1\\ 0\end{bmatrix}\]</span> Clearly, <span class="math inline">\(\eta_t\)</span> is just a 1-D normal with variance <span class="math inline">\(Q_t\)</span>, and thus as <span class="math inline">\(\alpha_t\)</span> evolves over time its element <span class="math inline">\(\nu_{n+1} = \nu_{n}\)</span> for all <span class="math inline">\(n\in [1,t]\)</span>. The variable <span class="math inline">\(\nu\)</span> here could be considered a static industry trend and <span class="math inline">\(\mu_t\)</span> is the random walk it perturbs. I’m sure you can already see the powerful flexibility we’ve been afforded by this modeling system.</p>
<p>Now, the only variables I have yet to mention are <span class="math inline">\(a_1\)</span> and <span class="math inline">\(P_1\)</span>. These dictate the distribution of our starting state. That is <span class="math inline">\(\alpha_1 \sim \mathcal{N}(a_1, P_1)\)</span>. These initial values are assumed to be known at the time of modeling. In reality these are rarely known and there is a large amount of theory to approximate the best starting value of these based on asymptotics. For more information, check out chapter 5 of <span class="citation" data-cites="book">(<a href="#ref-book" role="doc-biblioref">James Durbin and Koopman 2012</a>)</span>. But, we are Bayesians after all are we not? If we don’t know something we just chuck a prior at it. Although we will abide by the suggestion in chapter 5 and set <span class="math inline">\(a_1 = \bf{0}\)</span>.</p>
<p>I don’t know if you can tell, but this notation is incredibly loaded, and unfortunately it is only going to get worse before it gets better. The most loaded of them all is understanding when we are talking about a state vector <span class="math inline">\(\alpha_t\)</span> or the expected value of a state, denoted by <span class="math inline">\(a_t\)</span>. To hopefully alleviate some of notation burden, here is a footnote that shows the definition for all <span class="math inline">\(\alpha_t\)</span> or <span class="math inline">\(a_t\)</span> variations we might encounter.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</section>
<section id="i-prefer-autumn" class="level2">
<h2 class="anchored" data-anchor-id="i-prefer-autumn">I prefer Autumn</h2>
<p>One of the key components we’ll utilize is seasonality. This means that for some repeating point in time, we want to see the same, or slightly modified effect. For example, we might observe seasonality in consumer purchasing behavior. Big spikes occur during the holidays when everyone is purchasing Tumbler v2s to give to their ice enthusiast friends at Christmas, but then sales slowly die off. It’s a tale as old as time that we’ll see again next Christmas.</p>
<p>We’ll go about this by considering a 4 season example. This might be data that is collected every quarter for a company. We’ll define four season parameters denoted by <span class="math inline">\(\tau_j\)</span>, where <span class="math inline">\(j \in [1,4]\)</span>. We’ll make the assumption that all seasonal effects will add to zero. This makes sense if we assume that a seasonal effect is just some perturbation against the underlying trend. Consider the following:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>n_ex1 <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">*</span><span class="dv">5</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ss_comp_ex1 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">2</span><span class="sc">*</span>pi, <span class="at">length.out=</span><span class="dv">4</span>))<span class="sc">*</span><span class="dv">2</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>ss_ex1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(ss_comp_ex1 <span class="sc">-</span> <span class="fu">mean</span>(ss_comp_ex1),<span class="dv">5</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>trend_ex1 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(n_ex1) <span class="sc">+</span> <span class="fl">0.5</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>t_cex <span class="ot">&lt;-</span> <span class="fl">1.6</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">1</span>))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># layout_mat &lt;- matrix(c(1,2,3,3), nrow=2, byrow=T)</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># layout(layout_mat)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>)<span class="sc">-</span><span class="fl">0.5</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ss_ex1, <span class="at">type=</span><span class="st">'b'</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">xlab=</span><span class="st">''</span>, <span class="at">ylab=</span><span class="st">''</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">'Seasonality'</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">yaxt=</span><span class="st">'n'</span>,<span class="at">cex.main=</span>t_cex)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(trend_ex1, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">type=</span><span class="st">'b'</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">xlab=</span><span class="st">''</span>, <span class="at">ylab=</span><span class="st">''</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">'Underlying Trend'</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">yaxt=</span><span class="st">'n'</span>, <span class="at">cex.main=</span>t_cex)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ss_ex1 <span class="sc">+</span> trend_ex1, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">type=</span><span class="st">'b'</span>, <span class="at">xlab=</span><span class="st">''</span>, <span class="at">ylab=</span><span class="st">''</span>, </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">'Observed Trend'</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">yaxt=</span><span class="st">'n'</span>, <span class="at">cex.main=</span>t_cex)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Let’s write our system in plain Greek and forget about the matrices for a second:</p>
<p><span class="math display">\[\begin{align}
y_t &amp;= \mu_t + \tau_t + \varepsilon_t\\
\mu_{t + 1} &amp;= \mu_{t} + \eta_{t}^\mu\\
\tau_{t+1} &amp;= -\sum_{j=1}^{s-1}\tau_{t + 1 - j} + \eta_t^\tau
\end{align}\]</span></p>
<p>For some, that summation might have come out of left field. But recall that we defined our seasonality components to sum to zero. Therefore, for any <span class="math inline">\(s\)</span> length seasonality trend, we only need <span class="math inline">\(s-1\)</span> components to recover the full trend. For example if we have a seasonal trend of length 4 and trying to find the expected seasonal component of time <span class="math inline">\(t+1\)</span>, we can use the following:</p>
<p><span class="math display">\[\begin{align}
0 &amp;= \tau_{t+1} + \tau_{t} + \tau_{t-1} + \tau_{t-2}\\
\tau_{t+1} &amp;= -(\tau_{t} + \tau_{t-1} + \tau_{t-2})\\
\tau_{t+1} &amp;= -\sum_{j=1}^{s-1}\tau_{t + 1 - j}\\
\end{align}\]</span></p>
<p>Since we want to allow our seasonality to vary over time, we add a disturbance <span class="math inline">\(\eta_t^\tau\)</span> every time the next expected seasonality component <span class="math inline">\(\tau_{t+1}\)</span> is calculated. Note, since we want both <span class="math inline">\(\mu_t\)</span> and <span class="math inline">\(\tau_t\)</span> to vary over time, <span class="math inline">\(\eta_t\)</span> will be a vector of length 2. Finally, we can write our state space system matrices as:</p>
<p><span class="math display">\[\alpha_t = \begin{bmatrix} \mu_t \\ \tau_{t} \\ \tau_{t-1} \\ \tau_{t-2}\end{bmatrix} \hspace{10mm} Z_t = \begin{bmatrix} 1 &amp; 1 &amp; 0 &amp; 0\\ \end{bmatrix}\]</span> <span class="math display">\[T_t = \begin{bmatrix}1 &amp; 0 &amp; 0 &amp; 0\\ 0 &amp; -1 &amp; -1 &amp; -1\\0 &amp; 1 &amp; 0 &amp; 0\\0 &amp; 0 &amp; 1 &amp; 0\end{bmatrix} \hspace{5mm} R_t = \begin{bmatrix}1 &amp; 0\\ 0 &amp; 1\\0 &amp;0\\0&amp;0\end{bmatrix}\]</span> The 1s in the third and fourth row of <span class="math inline">\(T_t\)</span> ensure that we carry the <span class="math inline">\(s-2\)</span> most recent seasonal components with us to the next state. The 0s in the third and fourth row of <span class="math inline">\(R_t\)</span> <em>select</em> our disturbance draw such that no variation will be applied to the <span class="math inline">\(s-2\)</span> carryover seasonal states.</p>
</section>
<section id="who-got-a-call-back" class="level2">
<h2 class="anchored" data-anchor-id="who-got-a-call-back">Who got a call back?</h2>
<p>So now that we’ve hosted the auditions, who should we call back to comprise our final ensemble? Looking at the sales trend line, we see that there are two main competitors: “Abominable Snowman” and “Bigfoot”. We’ll use those two trends as covariates for our state space model. We can omit the slope <span class="math inline">\(\nu_t\)</span> with our reasoning being that any industry trend will already be captured by including the covariates. Finally, a 7 day seasonality trend will be considered to account for any within week variation. In practice, this can usually be also be omitted if we assume that the covariates can explain this variation as well, but we’ll keep seasonality for demonstration.</p>
<p>Now, let me introduce the stars of the play:</p>
<p><span class="math display">\[\alpha_t = \begin{bmatrix} \mu_t \\ \tau_{t} \\ \tau_{t-1} \\ \tau_{t-2}\\ \tau_{t-3}\\ \tau_{t-4}\\ \tau_{t-5}\\ \beta_a\\ \beta_b\end{bmatrix} \hspace{10mm} Z_t = \begin{bmatrix} 1 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; x_{a} &amp; x_b\\ \end{bmatrix}\]</span> where <span class="math inline">\((\beta_a, \beta_b)\)</span> and <span class="math inline">\((x_a, x_b)\)</span> are the regression coefficients and observed sales trend for “Abominable Snowman” and “Bigfoot”, respectively.</p>
<p><span class="math display">\[T_t = \begin{bmatrix}1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; -1 &amp; -1 &amp; -1 &amp; -1 &amp; -1 &amp; -1 &amp; 0 &amp; 0\\
0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1\\\end{bmatrix} \hspace{5mm}
R_t = \begin{bmatrix}1 &amp; 0\\ 0 &amp; 1\\0 &amp;0\\0&amp;0\\0&amp;0\\0&amp;0\\0&amp;0\\0&amp;0\\0&amp;0\end{bmatrix}\]</span></p>
<p>Since we are only varying the seasonality and <span class="math inline">\(\mu\)</span> over time, our disturbance <span class="math inline">\(\eta_t\)</span> covariance matrix is given by <span class="math inline">\(Q_t = \text{diag}(\sigma_{\mu}, \sigma_{\tau})\)</span>. Furthermore, since <span class="math inline">\(y_t\)</span> is univariate, our disturbance <span class="math inline">\(\varepsilon_t\)</span> has scalar variance <span class="math inline">\(H_t = \sigma_y\)</span>.</p>
</section>
</section>
<section id="setting-the-stage" class="level1">
<h1>Setting the Stage</h1>
<section id="mine-is-a-brita" class="level2">
<h2 class="anchored" data-anchor-id="mine-is-a-brita">Mine is a Brita</h2>
<p>The first step of our modeling process is <strong>filtering</strong>.</p>
<p>For sake of completeness, let’s review the assumptions<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> we made about our data generating process by imposing this system of equations:</p>
<ol type="1">
<li><span class="math inline">\(y_t\)</span> is a linear function of the latent state <span class="math inline">\(\alpha_t\)</span></li>
<li>The disturbances of our data generating process are normally distributed</li>
<li>The disturbances of our latent state are normally distributed.</li>
</ol>
<p>These unassuming<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> assumptions allow us to now leverage the power of the <a href="https://www.kalmanfilter.net/background.html">Kalman filter</a>. Without going into too much detail, filtering is just the process of updating what we expect given what we have observed. Assume that we have seen the first 4 realizations of some time series process. We are not in the dark about. We have <em>some</em> knowledge about what the 5th observation might be. If the first 4 had values between 1 and 10, we can be pretty sure that the 5th realization won’t be 1,000. This is of course a gross oversimplification, but if our process follows the assumptions outlined above, we can use the Kalman filter to quantify the uncertainty and expected value of our 5th observation.</p>
<p>If we had the time I would write out the derivation for you, but I already feel like I’m going to write too much. Instead, I refer you to page 82-85 of <span class="citation" data-cites="book">(<a href="#ref-book" role="doc-biblioref">James Durbin and Koopman 2012</a>)</span> or this <a href="https://nrotella.github.io/journal/kalman-filter-derivation-interpretation.html">cool blog post</a>. Now, you’ve met the star cast but do you know their origin story:</p>
<p><span class="math display">\[
\begin{align*}
v_t &amp;= y_t - Z_ta_t &amp; F_t &amp;= Z_t P_t Z^\prime_t + H_t \\
a_{t|t} &amp;= a_t + P_t Z^\prime_t F^{-1}_t v_t &amp; P_{t|t} &amp;= P_t - P_t Z^\prime_t F^{-1}_t Z_t P_t \\
a_{t+1} &amp;= T_t a_t + K_t v_t &amp; P_{t+1} &amp;= T_t P_t (T_t - K_t Z_t)^\prime + R_t Q_t R^\prime_t
\end{align*}
\]</span> Looks like we picked up some side characters on the way. The matrix <span class="math inline">\(K_t\)</span> is referred to as the Kalman Gain and is given by <span class="math inline">\(K_t = T_tP_tZ^\prime_tF^{-1}_t\)</span>. It encodes how much we should trust a given observation <span class="math inline">\(y_t\)</span>. If the gain is high, then the observation uncertainty is low and the next predicted state has a high dependence on the previous observation. If the gain is low, there is high uncertainty in the observation and thus we put most of our weight in the previous predicted state <span class="math inline">\(a_t\)</span>. For a more detailed inerpretation, take a look at this <a href="https://dsp.stackexchange.com/questions/2347/how-to-understand-kalman-gain-intuitively">stackoverflow post</a>.</p>
<p>The matrix <span class="math inline">\(F_t\)</span> is defined as <span class="math inline">\(\textrm{Var}[v_t|Y_{t-1}]\)</span> and the conditional expected value and variance of the state is defined as:</p>
<p><span class="math display">\[
\begin{align*}
a_{t|t}&amp;=\mathbb{E}[\alpha_t|Y_t] &amp; P_{t|t}&amp;=\textrm{Var}[\alpha_t|Y_t] \\
\end{align*}
\]</span> where <span class="math inline">\(Y_t = \{y_1,y_2,\dots,y_t\}\)</span>. In practice, you can actually ignore the middle row (<span class="math inline">\(*_{t|t}\)</span>) but we include it for completeness. Now, let’s apply the above equations to produce the filtered expected states <span class="math inline">\(a_{t|t}\)</span>. Since we are trying to understand the state of the system prior to our launch of the Tumbler v2™, we will exclude the data post launch from our analysis. Note, the functions used throughout this analysis are loaded into a environment variable <code>state_space_utils</code> in the first hidden block. The full source code for the various functions can be found <a href="https://github.com/TheNudibranch/TheNudibranch.github.io/blob/main/blog/pages/state_space/state_space_model_utilities.R">here under the project directory</a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>y_vec_no_prod <span class="ot">&lt;-</span> y_vec[<span class="sc">!</span>is_new_prod_live]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>k_obj <span class="ot">&lt;-</span> state_space_utils<span class="sc">$</span><span class="fu">forward_backward_pass</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  y_vec_no_prod, <span class="at">a_1=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">9</span>), </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">P_1 =</span> state_space_utils<span class="sc">$</span><span class="fu">iden</span>(<span class="dv">9</span>)<span class="sc">*</span><span class="fl">0.5</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">var_vec =</span> <span class="fu">c</span>(mu_var, ss_var), </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_var =</span> <span class="fu">c</span>(noise_var),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">list</span>(<span class="st">'include_slope'</span><span class="ot">=</span>F, <span class="at">x_mat=</span><span class="fu">cbind</span>(x1,x2)[<span class="sc">!</span>is_new_prod_live,], <span class="at">n_seasons=</span><span class="dv">7</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>filtered <span class="ot">&lt;-</span> y_vec_no_prod <span class="sc">-</span> (k_obj<span class="sc">$</span>forw<span class="sc">$</span>v <span class="sc">|&gt;</span> <span class="fu">unlist</span>())</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>smoothed <span class="ot">&lt;-</span> y_vec_no_prod <span class="sc">-</span> (k_obj<span class="sc">$</span>back<span class="sc">$</span>v_smth <span class="sc">|&gt;</span> <span class="fu">unlist</span>())</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> state_space_utils<span class="sc">$</span><span class="fu">simulate_state</span>(</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  k_obj<span class="sc">$</span>back<span class="sc">$</span>alpha_smth, <span class="at">a_1=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">9</span>), </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">P_1 =</span> state_space_utils<span class="sc">$</span><span class="fu">iden</span>(<span class="dv">9</span>)<span class="sc">*</span><span class="fl">0.5</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">var_vec =</span> <span class="fu">c</span>(mu_var, ss_var), <span class="at">noise_var =</span> <span class="fu">c</span>(noise_var),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">list</span>(<span class="st">'include_slope'</span><span class="ot">=</span>F, <span class="at">x_mat=</span><span class="fu">cbind</span>(x1,x2)[<span class="sc">!</span>is_new_prod_live,], <span class="at">n_seasons=</span><span class="dv">7</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y_vec_no_prod, <span class="at">type=</span><span class="st">'n'</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">cex.axis=</span><span class="fl">1.2</span>, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">cex.main=</span><span class="fl">1.5</span>, </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">''</span>, <span class="at">xlab=</span><span class="st">''</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">yaxt=</span><span class="st">'n'</span>, <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(y_vec_no_prod, filtered, smoothed)))</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">1</span>, <span class="at">at=</span><span class="fu">mean</span>(<span class="fu">seq_along</span>(y_vec_no_prod)), <span class="at">labels=</span><span class="st">'Time'</span>, <span class="at">cex.axis=</span><span class="fl">1.3</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">2</span>, <span class="at">at=</span><span class="fu">mean</span>(y_vec_no_prod), <span class="at">labels=</span><span class="st">'Sales ($)'</span>, <span class="at">cex.axis=</span><span class="fl">1.3</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(filtered, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">'darkred'</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y_vec_no_prod, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">type=</span><span class="st">'b'</span>, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'LENI Sales'</span>, <span class="st">'LENI Sales Filtered'</span>), <span class="at">lwd=</span><span class="dv">3</span>,<span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'darkred'</span>), <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">16</span>,<span class="cn">NA</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dont-forget-to-moisturize" class="level2">
<h2 class="anchored" data-anchor-id="dont-forget-to-moisturize">Don’t forget to Moisturize</h2>
<p>So you’ve done your filtering, but we don’t want dry flaky equations. For that you’re going to need to moisturize, or as the mathematicians call it: <strong>smoothing</strong>. You can think of filtering as the forward pass and smoothing as the backward pass. Filtering helped us get the finish line and find the next expected quantity given what we have seen so far. But now that we are at the final time step, we can go backwards and update our states with the entire series of observations, <span class="math inline">\(Y_n\)</span>. There are smoothing equations for the smoothed disturbances of <span class="math inline">\(\varepsilon_t\)</span> and <span class="math inline">\(\eta_t\)</span>, which we will denote <span class="math inline">\(\hat{\varepsilon}_t\)</span> and <span class="math inline">\(\hat{\eta}_t\)</span> respectively, but we will omit those since we are only concerned with the smoothed state <span class="math inline">\(\hat{\alpha}_t\)</span> inference.</p>
<p>We define <span class="math inline">\(\hat{\alpha}_t = \mathbb{E}[\alpha_t|Y_n]\)</span>. Note, this is different from <span class="math inline">\(a_{t|t}\)</span> in filtering due to the condition. The series <span class="math inline">\(Y_t\)</span> is defined as the series of observations up to time <span class="math inline">\(t\)</span> given by <span class="math inline">\(Y_t = \{y_1, y_2, \dots,y_t\}\)</span>, but <span class="math inline">\(Y_n\)</span> is the entire series of <span class="math inline">\(n\)</span> observations. As with filtering, I omit the proof of the smoothing equations and instead refer you to pages 88-91 of <span class="citation" data-cites="book">(<a href="#ref-book" role="doc-biblioref">James Durbin and Koopman 2012</a>)</span>. The smoothing equations are relatively simpler, given by</p>
<p><span class="math display">\[
\begin{align*}
r_{t-1} &amp;= Z_t^\prime F_t^{-1} v_t + L_t^\prime r_t &amp; \hat{\alpha_t} &amp;= a_t + P_t r_{t-1}
\end{align*}
\]</span> What fresh hell is this? We just keep getting more and more cast members? I promise, this was the last audition, they’ll be no more late additions. The matrix <span class="math inline">\(L_t\)</span> is present only for convenience and is defined as <span class="math inline">\(L_t = T_t - K_t Z_t\)</span>. As I said before, this is the backward pass. When we start to compute our smoothed states, we will go in reverse following <span class="math inline">\(t=n,\dots,1\)</span>, with <span class="math inline">\(r_n = 0\)</span>. Let’s see how our smoothed trend <span class="math inline">\(\hat{\alpha}_t\)</span> compares to our filtered trend:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y_vec_no_prod, <span class="at">type=</span><span class="st">'n'</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">cex.axis=</span><span class="fl">1.2</span>, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">cex.main=</span><span class="fl">1.5</span>,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">''</span>, <span class="at">xlab=</span><span class="st">''</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">yaxt=</span><span class="st">'n'</span>, <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(y_vec_no_prod, filtered, smoothed)))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">1</span>, <span class="at">at=</span><span class="fu">mean</span>(<span class="fu">seq_along</span>(y_vec_no_prod)), <span class="at">labels=</span><span class="st">'Time'</span>, <span class="at">cex.axis=</span><span class="fl">1.3</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">2</span>, <span class="at">at=</span><span class="fu">mean</span>(y_vec_no_prod), <span class="at">labels=</span><span class="st">'Sales ($)'</span>, <span class="at">cex.axis=</span><span class="fl">1.3</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(filtered, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">'darkred'</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(smoothed, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">'darkblue'</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y_vec_no_prod, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">type=</span><span class="st">'b'</span>, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'LENI Sales'</span>, <span class="st">'LENI Sales Filtered'</span>, <span class="st">'LENI Sales Smoothed'</span>), </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd=</span><span class="dv">3</span>,<span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'darkred'</span>, <span class="st">'darkblue'</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">bg=</span><span class="fu">adjustcolor</span>(<span class="st">'white'</span>, <span class="fl">0.5</span>), <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">16</span>,<span class="cn">NA</span>,<span class="cn">NA</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>You’ll notice that the largest deviations from filtered to smooth are towards the beginning of the series when the system has the least amount of information.</p>
</section>
<section id="lots-and-lots-of-understudies" class="level2">
<h2 class="anchored" data-anchor-id="lots-and-lots-of-understudies">Lots and Lots of Understudies</h2>
<p>Alright, so we went forward, we went backward, what’s left before show time? <strong>Simulating</strong>. I’m not one for point estimates. If given the option I’d rather work with a distribution, which works nicely with our chosen Bayesian workflow. Our distribution of interest is <span class="math inline">\(P(\alpha|Y_n)\)</span>, with individual draws denoted as <span class="math inline">\(\tilde{\alpha}\)</span>. How do we go about sampling this? Luckily, Durbin and Koopman have us covered once again <span class="citation" data-cites="sim_paper">(<a href="#ref-sim_paper" role="doc-biblioref">J. Durbin and Koopman 2002</a>)</span>.</p>
<p>The first step in simulating is realizing that we have the blueprints to play the system forward from some starting state <span class="math inline">\(\alpha_1\)</span> if we are given <span class="math inline">\(H_t\)</span>, <span class="math inline">\(Q_t\)</span>, <span class="math inline">\(a_1\)</span>, and <span class="math inline">\(P_1\)</span> (we’ll get to estimating those later). We’ll use the <span class="math inline">\(*^+\)</span> notation for describing draws that have been generated from evolving our system forward with random initializations. For example, <span class="math inline">\(\alpha^+ = [\alpha_1^+, \alpha_2^+,\dots,\alpha_n^+]\)</span>, where <span class="math inline">\(\alpha_1^+\)</span> was drawn from <span class="math inline">\(\mathcal{N}(a_1, P_1)\)</span> and the rest of the states simulated from recursively applying equations <span class="math inline">\(\text{(1)}\)</span> and <span class="math inline">\(\text{(2)}\)</span>.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Here are the steps fully laid out for simulating <span class="math inline">\(*^+\)</span>:</p>
<ol type="1">
<li>Draw <span class="math inline">\(\alpha^+_1\)</span> from the distribution <span class="math inline">\(\mathcal{N}(a_1, P_1)\)</span></li>
<li>Set <span class="math inline">\(t=1\)</span></li>
<li>Draw <span class="math inline">\(\varepsilon_t\)</span> from <span class="math inline">\(\mathcal{N}(0, H_t)\)</span> and <span class="math inline">\(\nu_t\)</span> from <span class="math inline">\(\mathcal{N}(0, Q_t)\)</span></li>
<li>Simulate the observation <span class="math inline">\(y^+_t\)</span> using equation <span class="math inline">\(\text{(1)}\)</span></li>
<li>Simulate the next state <span class="math inline">\(\alpha^+_{t+1}\)</span> using equation <span class="math inline">\(\text{(2)}\)</span></li>
<li>Set <span class="math inline">\(t = t+1\)</span></li>
<li>Return to step 3</li>
</ol>
<p>Now that we have <span class="math inline">\(y^+\)</span>, we can calculate <span class="math inline">\(\hat{\alpha}^+\)</span> defined by <span class="math inline">\(E[\alpha|y^+]\)</span>. The equations used for finding <span class="math inline">\(\hat{\alpha}^+\)</span> are the same ones we used for filtering and smoothing above. Finally, we may use the culmination of the <span class="citation" data-cites="sim_paper">(<a href="#ref-sim_paper" role="doc-biblioref">J. Durbin and Koopman 2002</a>)</span> paper to yield <span class="math inline">\(\tilde{\alpha}\)</span>, given by:</p>
<p><span class="math display">\[\tilde{\alpha} = \alpha^+ - \hat{\alpha}^+ + \hat{\alpha}\]</span> Using the methodology outline above, we can now plot the simulated states:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>y_sim <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>alpha_sim <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>z_list <span class="ot">&lt;-</span> state_space_utils<span class="sc">$</span><span class="fu">gen_Z_list</span>(<span class="fu">length</span>(y_vec_no_prod), <span class="at">include_slope=</span>F,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">x_mat=</span><span class="fu">cbind</span>(x1,x2)[<span class="sc">!</span>is_new_prod_live,], <span class="at">n_seasons=</span><span class="dv">7</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> state_space_utils<span class="sc">$</span><span class="fu">simulate_state</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    k_obj<span class="sc">$</span>back<span class="sc">$</span>alpha_smth, <span class="at">a_1=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">9</span>),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">P_1 =</span> state_space_utils<span class="sc">$</span><span class="fu">iden</span>(<span class="dv">9</span>)<span class="sc">*</span><span class="fl">0.5</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_vec =</span> <span class="fu">c</span>(mu_var, ss_var), <span class="at">noise_var =</span> <span class="fu">c</span>(noise_var),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> <span class="fu">list</span>(<span class="st">'include_slope'</span><span class="ot">=</span>F, <span class="at">x_mat=</span><span class="fu">cbind</span>(x1,x2)[<span class="sc">!</span>is_new_prod_live,], <span class="at">n_seasons=</span><span class="dv">7</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  alpha_sim[[i]] <span class="ot">&lt;-</span> sim</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  y_sim[[i]] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(y_vec_no_prod), \(x) z_list[[x]] <span class="sc">%*%</span> sim[[x]]) <span class="sc">|&gt;</span> <span class="fu">unlist</span>()</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y_vec_no_prod, <span class="at">type=</span><span class="st">'n'</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">cex.axis=</span><span class="fl">1.2</span>, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">cex.main=</span><span class="fl">1.5</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">''</span>, <span class="at">xlab=</span><span class="st">''</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">yaxt=</span><span class="st">'n'</span>, <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(y_vec_no_prod, filtered, smoothed)))</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">1</span>, <span class="at">at=</span><span class="fu">mean</span>(<span class="fu">seq_along</span>(y_vec_no_prod)), <span class="at">labels=</span><span class="st">'Time'</span>, <span class="at">cex.axis=</span><span class="fl">1.3</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">2</span>, <span class="at">at=</span><span class="fu">mean</span>(y_vec_no_prod), <span class="at">labels=</span><span class="st">'Sales ($)'</span>, <span class="at">cex.axis=</span><span class="fl">1.3</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>y_sim <span class="sc">|&gt;</span> <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">matrix</span>(<span class="at">ncol=</span><span class="fu">length</span>(y_vec_no_prod), <span class="at">byrow=</span>T) <span class="sc">|&gt;</span> </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  state_space_utils<span class="sc">$</span><span class="fu">time_series_err</span>()</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(y_vec_no_prod, <span class="at">type=</span><span class="st">'b'</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'LENI Sales'</span>, <span class="st">'Simulated State'</span>),</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>, <span class="cn">NA</span>),</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">16</span>,<span class="dv">22</span>),</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">pt.cex=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="cn">NA</span>),</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="cn">NA</span>),</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">pt.bg=</span><span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">adjustcolor</span>(<span class="st">'darkblue'</span>,<span class="fl">0.2</span>)),</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>               <span class="at">bg=</span><span class="fu">adjustcolor</span>(<span class="st">'white'</span>, <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="end-of-act-1" class="level1">
<h1>End of Act 1</h1>
<p>The curtains have closed and you may now take a brief intermission. There is still a lot of be done though. We have only talked about the nuts and bolts of the state space model and haven’t even begun our exciting applications outlined at the beginning. We may have a framework that describes the data generating process, but there has been no work on any parameter inference. Spoiler alert, this is where Stan comes into play. In the next section we will:</p>
<ul>
<li>Use <a href="https://mc-stan.org/">Stan</a> as our inference engine for the model outlined</li>
<li>Interrogate the posterior distribution of the model’s parameters to validate the initial assumptions</li>
<li>Predict the next states and observations credible intervals to back into a incremental estimate for our marketing campaign (the primary objective)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 10 x64 (build 19045)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/New_York
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] kableExtra_1.4.0 cmdstanr_0.8.1  

loaded via a namespace (and not attached):
 [1] jsonlite_1.8.9       compiler_4.4.2       Rcpp_1.0.13-1       
 [4] xml2_1.3.6           stringr_1.5.1        parallel_4.4.2      
 [7] systemfonts_1.1.0    scales_1.3.0         yaml_2.3.10         
[10] fastmap_1.2.0        R6_2.5.1             generics_0.1.3      
[13] curl_6.0.1           distributional_0.5.0 knitr_1.49          
[16] MASS_7.3-61          htmlwidgets_1.6.4    backports_1.5.0     
[19] colormap_0.1.4       checkmate_2.3.2      tibble_3.2.1        
[22] munsell_0.5.1        svglite_2.1.3        pillar_1.9.0        
[25] posterior_1.6.0      rlang_1.1.4          V8_6.0.0            
[28] utf8_1.2.4           stringi_1.8.4        xfun_0.49           
[31] viridisLite_0.4.2    cli_3.6.3            magrittr_2.0.3      
[34] ps_1.8.1             digest_0.6.37        processx_3.8.4      
[37] rstudioapi_0.17.1    lifecycle_1.0.4      vctrs_0.6.5         
[40] evaluate_1.0.1       glue_1.8.0           tensorA_0.36.2.1    
[43] abind_1.4-8          fansi_1.0.6          colorspace_2.1-1    
[46] rmarkdown_2.29       tools_4.4.2          pkgconfig_2.0.3     
[49] htmltools_0.5.8.1   </code></pre>
</div>
</div>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-book" class="csl-entry" role="listitem">
Durbin, James, and Siem Jan Koopman. 2012. <em><span class="nocase">Time Series Analysis by State Space Methods</span></em>. Oxford University Press. <a href="https://doi.org/10.1093/acprof:oso/9780199641178.001.0001">https://doi.org/10.1093/acprof:oso/9780199641178.001.0001</a>.
</div>
<div id="ref-sim_paper" class="csl-entry" role="listitem">
Durbin, J., and S. J. Koopman. 2002. <span>“A Simple and Efficient Simulation Smoother for State Space Time Series Analysis.”</span> <em>Biometrika</em> 89 (3): 603–15. <a href="http://www.jstor.org/stable/4140605">http://www.jstor.org/stable/4140605</a>.
</div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><span class="math inline">\(\alpha_t\)</span>: defined as the state as time t <br><span class="math inline">\(a_t = \mathbb{E}[\alpha_t|Y_{t-1}]\)</span> <br> <span class="math inline">\(a_{t|t} = \mathbb{E}[\alpha_t|Y_t]\)</span> <br> <span class="math inline">\(\hat{\alpha}_t=\mathbb{E}[\alpha_t|Y_n]\)</span>. This one irks me a bit. I’d prefer it be <span class="math inline">\(a_{t|n}\)</span> or <span class="math inline">\(\hat{a}_t\)</span>, but it makes sense if they wanted to be consistent with the sampling notation. <br> <span class="math inline">\(\tilde{\alpha}_t\)</span>: a draw from the distribution <span class="math inline">\(P(\alpha|Y_n)\)</span> <br> <span class="math inline">\(\alpha^+\)</span>: a draw from the distribution <span class="math inline">\(P(\alpha)\)</span>, the unconditional distribution <br> <span class="math inline">\(\hat{\alpha}^+ = \mathbb{E}[\alpha|y^+]\)</span>, where <span class="math inline">\(y^+\)</span> are the observations from evolving the system forward given a random initialization drawn from the known disturbance variances and <span class="math inline">\(\alpha_1\)</span> distribution.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>You can actually drop the normality assumptions of the disturbances if you’re willing to work with the <em>minimum variance linear unbiased estimate</em> (MVLUE) instead<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Or incredibly assuming<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Durbin &amp; Koopman actually using <span class="math inline">\(\prime\)</span> when describing individual draws within the <span class="math inline">\(*^+\)</span> vector, I have chosen to use <span class="math inline">\(*^+_t\)</span> to keep the notation less overwhelming<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>